
"""
1D Plasticity
"""
function (op::Operator{:âˆ«vâ‚“Ïƒdx})(ap::T,k::AbstractMatrix{Float64},fint::AbstractVector) where T<:AbstractElement
    ğ“’ = ap.ğ“’; ğ“– = ap.ğ“–
    E = op.E
    K = op.K
    Ïƒy = op.Ïƒy
    for Î¾ in ğ“–
        B = Î¾[:âˆ‚ğ­âˆ‚x]
        Ïƒâ‚™ = Î¾.Ïƒâ‚™
        Î±â‚™ = Î¾.Î±â‚™
        Îµáµ–â‚™ = Î¾.Îµáµ–â‚™
        ğ‘¤ = Î¾.ğ‘¤
        Î”Îµâ‚™ = 0.0
        for (i,xáµ¢) in enumerate(ğ“’)
            Î”Îµâ‚™ += B[i]*xáµ¢.Î”d
        end
        # predict phase
        Ïƒáµ—Ê³ = Ïƒâ‚™+E*Î”Îµâ‚™
        fáµ—Ê³ = abs(Ïƒáµ—Ê³) - (Ïƒy+K*Î±â‚™)
        if fáµ—Ê³ > 1E-13
            Î”Î³ = fáµ—Ê³/(E+K)
            Î¾.Ïƒâ‚™ = Ïƒáµ—Ê³ - Î”Î³*E*sign(Ïƒáµ—Ê³)
            Î¾.Îµáµ–â‚™ = Îµáµ–â‚™ + Î”Î³*sign(Ïƒáµ—Ê³)
            Î¾.Î±â‚™ = Î±â‚™ + Î”Î³
            Eâ‚œ = (E*K)/(E+K)
        else
            Î¾.Ïƒâ‚™ = Ïƒáµ—Ê³
            Eâ‚œ = E
        end
        for (i,xáµ¢) in enumerate(ğ“’)
            I = xáµ¢.ğ¼
            for (j,xâ±¼) in enumerate(ğ“’)
                J = xâ±¼.ğ¼
                k[I,J] += B[i]*Eâ‚œ*B[j]*ğ‘¤
            end
            fint[I] += B[i]*Î¾.Ïƒâ‚™*ğ‘¤
        end
    end
end

"""
Tresca
"""
function (op::Operator{:âˆ«váµ¢ÏƒdÎ©_tresca})(ap::T;k::AbstractMatrix{Float64},fint::AbstractVector{Float64}) where T<:AbstractElement
    ğ“’ = ap.ğ“’; ğ“– = ap.ğ“–
    Î» = op.Î»
    Î¼ = op.Î¼
    c = op.c
    Cáµ¢áµ¢áµ¢áµ¢ = Î» + 2.0*Î¼
    Cáµ¢áµ¢â±¼â±¼ = Î»
    Cáµ¢â±¼áµ¢â±¼ = Î¼
    
    # for Î¾ in ğ“–
    for (ii,Î¾) in enumerate(ğ“–)
        Bâ‚ = Î¾[:âˆ‚ğ­âˆ‚x]
        Bâ‚‚ = Î¾[:âˆ‚ğ­âˆ‚y]
        Ïƒâ‚â‚ = Î¾.Ïƒâ‚â‚
        Ïƒâ‚‚â‚‚ = Î¾.Ïƒâ‚‚â‚‚
        Ïƒâ‚â‚‚ = Î¾.Ïƒâ‚â‚‚
        Îµáµ–â‚â‚ = Î¾.Îµáµ–â‚â‚
        Îµáµ–â‚‚â‚‚ = Î¾.Îµáµ–â‚‚â‚‚
        Îµáµ–â‚â‚‚ = Î¾.Îµáµ–â‚â‚‚
        ğ‘¤ = Î¾.ğ‘¤
        Î”Îµâ‚â‚ = 0.0
        Î”Îµâ‚‚â‚‚ = 0.0
        Î”Îµâ‚â‚‚ = 0.0
        for (i,xáµ¢) in enumerate(ğ“’)
            Î”Îµâ‚â‚ += Bâ‚[i]*xáµ¢.Î”dâ‚
            Î”Îµâ‚‚â‚‚ += Bâ‚‚[i]*xáµ¢.Î”dâ‚‚
            Î”Îµâ‚â‚‚ += Bâ‚[i]*xáµ¢.Î”dâ‚‚ + Bâ‚‚[i]*xáµ¢.Î”dâ‚
        end 

        # predict phase
        Ïƒâ‚â‚áµ—Ê³ = Ïƒâ‚â‚ + Cáµ¢áµ¢áµ¢áµ¢*Î”Îµâ‚â‚+Cáµ¢áµ¢â±¼â±¼*Î”Îµâ‚‚â‚‚
        Ïƒâ‚‚â‚‚áµ—Ê³ = Ïƒâ‚‚â‚‚ + Cáµ¢áµ¢áµ¢áµ¢*Î”Îµâ‚‚â‚‚+Cáµ¢áµ¢â±¼â±¼*Î”Îµâ‚â‚
        Ïƒâ‚â‚‚áµ—Ê³ = Ïƒâ‚â‚‚ + Cáµ¢â±¼áµ¢â±¼*Î”Îµâ‚â‚‚
        Ïƒâ‚,Ïƒâ‚‚,nâ‚,nâ‚‚ = getÏƒâ‚™(Ïƒâ‚â‚áµ—Ê³,Ïƒâ‚‚â‚‚áµ—Ê³,Ïƒâ‚â‚‚áµ—Ê³)
        fáµ—Ê³ = Ïƒâ‚ - Ïƒâ‚‚ - 2.0*c

        if fáµ—Ê³ > 1E-13
            Î”Î³ = fáµ—Ê³/4.0/Î¼
           
            Î¾.Ïƒâ‚â‚ = Ïƒâ‚â‚áµ—Ê³ - Î”Î³*2.0*Î¼*(nâ‚[1]*nâ‚[1] - nâ‚‚[1]*nâ‚‚[1])
            Î¾.Ïƒâ‚‚â‚‚ = Ïƒâ‚‚â‚‚áµ—Ê³ - Î”Î³*2.0*Î¼*(nâ‚[2]*nâ‚[2] - nâ‚‚[2]*nâ‚‚[2])
            Î¾.Ïƒâ‚â‚‚ = Ïƒâ‚â‚‚áµ—Ê³ - Î”Î³*2.0*Î¼*(nâ‚[1]*nâ‚[2] - nâ‚‚[1]*nâ‚‚[2])
            Î¾.Îµáµ–â‚â‚ = Îµáµ–â‚â‚ + Î”Î³*(nâ‚[1]*nâ‚[1] - nâ‚‚[1]*nâ‚‚[1])
            Î¾.Îµáµ–â‚‚â‚‚ = Îµáµ–â‚‚â‚‚ + Î”Î³*(nâ‚[2]*nâ‚[2] - nâ‚‚[2]*nâ‚‚[2])
            Î¾.Îµáµ–â‚â‚‚ = Îµáµ–â‚â‚‚ + Î”Î³*(nâ‚[1]*nâ‚[2] - nâ‚‚[1]*nâ‚‚[2])

            Cáµ—â‚â‚â‚â‚ = Cáµ¢áµ¢áµ¢áµ¢ - Î¼*(nâ‚[1]*nâ‚[1] - nâ‚‚[1]*nâ‚‚[1])^2
            Cáµ—â‚‚â‚‚â‚‚â‚‚ = Cáµ¢áµ¢áµ¢áµ¢ - Î¼*(nâ‚[2]*nâ‚[2] - nâ‚‚[2]*nâ‚‚[2])^2
            Cáµ—â‚â‚â‚‚â‚‚ = Cáµ¢áµ¢â±¼â±¼ - Î¼*(nâ‚[1]*nâ‚[1] - nâ‚‚[1]*nâ‚‚[1])*(nâ‚[2]*nâ‚[2] - nâ‚‚[2]*nâ‚‚[2])
            Cáµ—â‚â‚‚â‚â‚‚ = Cáµ¢â±¼áµ¢â±¼ - 2.0*Î¼*(nâ‚[1]*nâ‚[2] - nâ‚‚[1]*nâ‚‚[2])^2
            Cáµ—â‚â‚â‚â‚‚ = - Î¼*(nâ‚[1]*nâ‚[1] - nâ‚‚[1]*nâ‚‚[1])*(nâ‚[1]*nâ‚[2] - nâ‚‚[1]*nâ‚‚[2])
            Cáµ—â‚‚â‚‚â‚â‚‚ = - Î¼*(nâ‚[2]*nâ‚[2] - nâ‚‚[2]*nâ‚‚[2])*(nâ‚[1]*nâ‚[2] - nâ‚‚[1]*nâ‚‚[2])
             #println(Cáµ—â‚â‚â‚â‚)
             #println(Cáµ—â‚‚â‚‚â‚‚â‚‚)
             #println(Cáµ—â‚â‚â‚‚â‚‚)
             #println(Cáµ—â‚â‚‚â‚â‚‚)
             #println(Cáµ—â‚â‚â‚â‚‚)
             #println(Cáµ—â‚‚â‚‚â‚â‚‚)
        else
            Î¾.Ïƒâ‚â‚ = Ïƒâ‚â‚áµ—Ê³
            Î¾.Ïƒâ‚‚â‚‚ = Ïƒâ‚‚â‚‚áµ—Ê³
            Î¾.Ïƒâ‚â‚‚ = Ïƒâ‚â‚‚áµ—Ê³
            Cáµ—â‚â‚â‚â‚ = Cáµ¢áµ¢áµ¢áµ¢
            Cáµ—â‚‚â‚‚â‚‚â‚‚ = Cáµ¢áµ¢áµ¢áµ¢
            Cáµ—â‚â‚â‚‚â‚‚ = Cáµ¢áµ¢â±¼â±¼
            Cáµ—â‚â‚‚â‚â‚‚ = Cáµ¢â±¼áµ¢â±¼
            Cáµ—â‚â‚â‚â‚‚ = 0.0
            Cáµ—â‚‚â‚‚â‚â‚‚ = 0.0
        end
       
        for (i,xáµ¢) in enumerate(ğ“’)
            I = xáµ¢.ğ¼
            for (j,xâ±¼) in enumerate(ğ“’)
                J = xâ±¼.ğ¼
                k[2*I-1,2*J-1] += (Cáµ—â‚â‚â‚â‚*Bâ‚[i]*Bâ‚[j] + Cáµ—â‚â‚‚â‚â‚‚*Bâ‚‚[i]*Bâ‚‚[j] + Cáµ—â‚â‚â‚â‚‚*(Bâ‚[i]*Bâ‚‚[j]+Bâ‚‚[i]*Bâ‚[j]))*ğ‘¤
                k[2*I-1,2*J]   += (Cáµ—â‚â‚â‚‚â‚‚*Bâ‚[i]*Bâ‚‚[j] + Cáµ—â‚â‚‚â‚â‚‚*Bâ‚‚[i]*Bâ‚[j] + Cáµ—â‚â‚â‚â‚‚*Bâ‚[i]*Bâ‚[j] + Cáµ—â‚‚â‚‚â‚â‚‚*Bâ‚‚[i]*Bâ‚‚[j])*ğ‘¤
                k[2*I,2*J-1]   += (Cáµ—â‚â‚â‚‚â‚‚*Bâ‚‚[i]*Bâ‚[j] + Cáµ—â‚â‚‚â‚â‚‚*Bâ‚[i]*Bâ‚‚[j] + Cáµ—â‚â‚â‚â‚‚*Bâ‚[i]*Bâ‚[j] + Cáµ—â‚‚â‚‚â‚â‚‚*Bâ‚‚[i]*Bâ‚‚[j])*ğ‘¤
                k[2*I,2*J]     += (Cáµ—â‚‚â‚‚â‚‚â‚‚*Bâ‚‚[i]*Bâ‚‚[j] + Cáµ—â‚â‚‚â‚â‚‚*Bâ‚[i]*Bâ‚[j] + Cáµ—â‚‚â‚‚â‚â‚‚*(Bâ‚[i]*Bâ‚‚[j]+Bâ‚‚[i]*Bâ‚[j]))*ğ‘¤
     
            end
            fint[2*I-1] += Bâ‚[i]*Î¾.Ïƒâ‚â‚*ğ‘¤ + Bâ‚‚[i]*Î¾.Ïƒâ‚â‚‚*ğ‘¤
            fint[2*I]   += Bâ‚[i]*Î¾.Ïƒâ‚â‚‚*ğ‘¤ + Bâ‚‚[i]*Î¾.Ïƒâ‚‚â‚‚*ğ‘¤
        end
    end
end    

"""
morh-coulbom
"""
function (op::Operator{:âˆ«váµ¢ÏƒdÎ©_mohr_coulomb})(ap::T;k::AbstractMatrix{Float64},fint::AbstractVector{Float64}) where T<:AbstractElement
    ğ“’ = ap.ğ“’; ğ“– = ap.ğ“–
    Î» = op.Î»
    Î¼ = op.Î¼
    c = op.c
    ğœ™ = op.ğœ™
    tol = op.tol 
    Cáµ¢áµ¢áµ¢áµ¢ = Î» + 2.0*Î¼
    Cáµ¢áµ¢â±¼â±¼ = Î»
    Cáµ¢â±¼áµ¢â±¼ = Î¼
    
    for (ii,Î¾) in enumerate(ğ“–)
        Bâ‚ = Î¾[:âˆ‚ğ­âˆ‚x]
        Bâ‚‚ = Î¾[:âˆ‚ğ­âˆ‚y]
        Ïƒâ‚â‚ = Î¾.Ïƒâ‚â‚
        Ïƒâ‚‚â‚‚ = Î¾.Ïƒâ‚‚â‚‚
        Ïƒâ‚ƒâ‚ƒ = Î¾.Ïƒâ‚ƒâ‚ƒ
        Ïƒâ‚â‚‚ = Î¾.Ïƒâ‚â‚‚
        Îµáµ–â‚â‚ = Î¾.Îµáµ–â‚â‚
        Îµáµ–â‚‚â‚‚ = Î¾.Îµáµ–â‚‚â‚‚
        Îµáµ–â‚â‚‚ = Î¾.Îµáµ–â‚â‚‚
        ğ‘¤ = Î¾.ğ‘¤
        Î”Îµâ‚â‚ = 0.0
        Î”Îµâ‚‚â‚‚ = 0.0
        Î”Îµâ‚â‚‚ = 0.0
        for (i,xáµ¢) in enumerate(ğ“’)
            Î”Îµâ‚â‚ += Bâ‚[i]*xáµ¢.Î”dâ‚
            Î”Îµâ‚‚â‚‚ += Bâ‚‚[i]*xáµ¢.Î”dâ‚‚
            Î”Îµâ‚â‚‚ += Bâ‚[i]*xáµ¢.Î”dâ‚‚ + Bâ‚‚[i]*xáµ¢.Î”dâ‚
        end 

        N = Î¾[:ğ­]
        v = 0.0
        âˆ‚vâˆ‚x = 0.0
        for (i,xáµ¢) in enumerate(ğ“’)
            v += N[i]*xáµ¢.v
            âˆ‚vâˆ‚x += B[i]*xáµ¢.v
        end
        # predict phase
        Ïƒâ‚â‚áµ—Ê³ = Ïƒâ‚â‚ + Cáµ¢áµ¢áµ¢áµ¢*Î”Îµâ‚â‚+Cáµ¢áµ¢â±¼â±¼*Î”Îµâ‚‚â‚‚
        Ïƒâ‚‚â‚‚áµ—Ê³ = Ïƒâ‚‚â‚‚ + Cáµ¢áµ¢áµ¢áµ¢*Î”Îµâ‚‚â‚‚+Cáµ¢áµ¢â±¼â±¼*Î”Îµâ‚â‚
        Ïƒâ‚â‚‚áµ—Ê³ = Ïƒâ‚â‚‚ + Cáµ¢â±¼áµ¢â±¼*Î”Îµâ‚â‚‚
        Ïƒâ‚,Ïƒâ‚‚,nâ‚,nâ‚‚ = getÏƒâ‚™(Ïƒâ‚â‚áµ—Ê³,Ïƒâ‚‚â‚‚áµ—Ê³,Ïƒâ‚â‚‚áµ—Ê³)
        fáµ—Ê³ = Ïƒâ‚-Ïƒâ‚‚ + (Ïƒâ‚+Ïƒâ‚‚) * sin(ğœ™) - 2.0*c*cos(ğœ™)
        #if fáµ—Ê³ > tol
        #    
        #  error("fáµ—Ê³ > tol!")
        #end
        if fáµ—Ê³ > tol
            sinğœ™ = sin(ğœ™)
            sinÂ²ğœ™ = sin(ğœ™)*sin(ğœ™)
            sinÂ²ğœ™psinğœ™ = sinÂ²ğœ™ +sin(ğœ™) 
            sinÂ²ğœ™dsinğœ™ = sinÂ²ğœ™ -sin(ğœ™) 
            âˆ‚fCâˆ‚f=(4.0*sinÂ²ğœ™*Î»+4.0*(1.0+sinÂ²ğœ™)*Î¼)
            Î”Î³ = fáµ—Ê³/âˆ‚fCâˆ‚f
           
            Î¾.Ïƒâ‚â‚ = Ïƒâ‚â‚áµ—Ê³ - Î”Î³*(2*sinğœ™*Î»+2*((sinğœ™+1)*nâ‚[1]*nâ‚[1]+(sinğœ™-1)*nâ‚‚[1]*nâ‚‚[1])*Î¼)#ä¸Šæ ‡1å¯¹åº”ä¹‹å‰ä¸‹æ ‡1
            Î¾.Ïƒâ‚‚â‚‚ = Ïƒâ‚‚â‚‚áµ—Ê³ - Î”Î³*(2*sinğœ™*Î»+2*((sinğœ™+1)*nâ‚[2]*nâ‚[2]+(sinğœ™-1)*nâ‚‚[2]*nâ‚‚[2])*Î¼)
            Î¾.Ïƒâ‚â‚‚ = Ïƒâ‚â‚‚áµ—Ê³ - Î”Î³*2*((sinğœ™+1)*nâ‚[1]*nâ‚[2]+(sinğœ™-1)*nâ‚‚[1]*nâ‚‚[2])*Î¼
            Î¾.Îµáµ–â‚â‚ = Îµáµ–â‚â‚ + Î”Î³*((sinğœ™+1)*nâ‚[1]*nâ‚[1]+(sinğœ™-1)nâ‚‚[1]*nâ‚‚[1])
            Î¾.Îµáµ–â‚‚â‚‚ = Îµáµ–â‚‚â‚‚ + Î”Î³*((sinğœ™+1)*nâ‚[2]*nâ‚[2]+(sinğœ™-1)nâ‚‚[2]*nâ‚‚[2])
            Î¾.Îµáµ–â‚â‚‚ = Îµáµ–â‚â‚‚ + Î”Î³*(((sinğœ™+1)*nâ‚[1]*nâ‚[2]+(sinğœ™-1)nâ‚‚[1]*nâ‚‚[2]))

            Cáµ—â‚â‚â‚â‚=Cáµ¢áµ¢áµ¢áµ¢-(4.0*sinÂ²ğœ™*Î»^2 + 8.0*sinÂ²ğœ™psinğœ™*Î»*Î¼*(nâ‚[1])^2 + 8.0*(sinÂ²ğœ™dsinğœ™)*Î»*Î¼*(nâ‚‚[1])^2-8.0*cos(ğœ™)*cos(ğœ™)*Î¼^2*nâ‚[1]^2*nâ‚‚[1]^2+4.0*(sinğœ™+1)^2*Î¼^2*(nâ‚[1])^4+4.0*(sinğœ™-1)^2*Î¼^2*(nâ‚‚[1])^4)/âˆ‚fCâˆ‚f
            Cáµ—â‚‚â‚‚â‚‚â‚‚=Cáµ¢áµ¢áµ¢áµ¢-(4.0*sinÂ²ğœ™*Î»^2 + 8.0*sinÂ²ğœ™psinğœ™*Î»*Î¼*(nâ‚[2])^2 + 8.0*(sinÂ²ğœ™dsinğœ™)*Î»*Î¼*(nâ‚‚[2])^2-8.0*cos(ğœ™)*cos(ğœ™)*Î¼^2*nâ‚[2]^2*nâ‚‚[2]^2+4.0*(sinğœ™+1)^2*Î¼^2*(nâ‚[2])^4+4.0*(sinğœ™-1)^2*Î¼^2*(nâ‚‚[2])^4)/âˆ‚fCâˆ‚f
            Cáµ—â‚â‚â‚‚â‚‚=Cáµ¢áµ¢â±¼â±¼-(4.0*sinÂ²ğœ™*Î»^2 + 4.0*sinÂ²ğœ™psinğœ™*Î»*Î¼*((nâ‚[1])^2+(nâ‚[2])^2)+4.0*(sinÂ²ğœ™dsinğœ™)*Î»*Î¼*((nâ‚‚[1])^2+(nâ‚‚[2])^2)+4.0*(sinğœ™+1)^2*Î¼^2*(nâ‚[1])^2*(nâ‚[2])^2-4.0*cos(ğœ™)*cos(ğœ™)*Î¼^2*((nâ‚‚[1])^2*(nâ‚[2])^2+(nâ‚[1])^2*(nâ‚‚[2])^2)+4.0*(sinğœ™-1)^2*Î¼^2*(nâ‚‚[1])^2*(nâ‚‚[2])^2)/âˆ‚fCâˆ‚f
            Cáµ—â‚â‚‚â‚â‚‚=Cáµ¢â±¼áµ¢â±¼-2.0(-8.0*cos(ğœ™)*cos(ğœ™)*Î¼^2*nâ‚[1]*nâ‚[2]*nâ‚‚[1]*nâ‚‚[2]+4.0*(sinğœ™+1)^2*Î¼^2*(nâ‚[1]*nâ‚[2])^2+4.0*(sinğœ™-1)^2*Î¼^2*(nâ‚‚[1]*nâ‚‚[2])^2)/âˆ‚fCâˆ‚f
            Cáµ—â‚â‚â‚â‚‚ = - (4.0*sinÂ²ğœ™psinğœ™*Î»*Î¼*nâ‚[1]*nâ‚[2] + 4.0*(sinÂ²ğœ™dsinğœ™)*Î»*Î¼*nâ‚‚[1]*nâ‚‚[2]-4.0*cos(ğœ™)*cos(ğœ™)*Î¼^2*nâ‚‚[1]^2*nâ‚[1]*nâ‚[2]-4.0*cos(ğœ™)*cos(ğœ™)*Î¼^2*nâ‚[1]^2*nâ‚‚[1]*nâ‚‚[2]+4.0*(sinğœ™+1)^2*Î¼^2*(nâ‚[1])^3*nâ‚[2]+4.0*(sinğœ™-1)^2*Î¼^2*(nâ‚‚[1])^3*nâ‚‚[2])/âˆ‚fCâˆ‚f
            Cáµ—â‚‚â‚‚â‚â‚‚ = - (4.0*sinÂ²ğœ™psinğœ™*Î»*Î¼*nâ‚[2]*nâ‚[1] + 4.0*(sinÂ²ğœ™dsinğœ™)*Î»*Î¼*nâ‚‚[2]*nâ‚‚[1]-4.0*cos(ğœ™)*cos(ğœ™)*Î¼^2*nâ‚‚[2]^2*nâ‚[2]*nâ‚[1]-4.0*cos(ğœ™)*cos(ğœ™)*Î¼^2*nâ‚[2]^2*nâ‚‚[2]*nâ‚‚[1]+4.0*(sinğœ™+1)^2*Î¼^2*(nâ‚[2])^3*nâ‚[1]+4.0*(sinğœ™-1)^2*Î¼^2*(nâ‚‚[2])^3*nâ‚‚[1])/âˆ‚fCâˆ‚f
            #println(Cáµ—â‚â‚â‚â‚)
            #println(Cáµ—â‚‚â‚‚â‚‚â‚‚)
            #println(Cáµ—â‚â‚â‚‚â‚‚)
            #println(Cáµ—â‚â‚‚â‚â‚‚)
            #println(Cáµ—â‚â‚â‚â‚‚)
            #println(Cáµ—â‚‚â‚‚â‚â‚‚)
        else
            Î¾.Ïƒâ‚â‚ = Ïƒâ‚â‚áµ—Ê³
            Î¾.Ïƒâ‚‚â‚‚ = Ïƒâ‚‚â‚‚áµ—Ê³
            Î¾.Ïƒâ‚â‚‚ = Ïƒâ‚â‚‚áµ—Ê³
            Cáµ—â‚â‚â‚â‚ = Cáµ¢áµ¢áµ¢áµ¢
            Cáµ—â‚‚â‚‚â‚‚â‚‚ = Cáµ¢áµ¢áµ¢áµ¢
            Cáµ—â‚â‚â‚‚â‚‚ = Cáµ¢áµ¢â±¼â±¼
            Cáµ—â‚â‚‚â‚â‚‚ = Cáµ¢â±¼áµ¢â±¼
            Cáµ—â‚â‚â‚â‚‚ = 0.0
            Cáµ—â‚‚â‚‚â‚â‚‚ = 0.0
        end
       # if isnan(Ïƒâ‚â‚)
       #    
       #       Ïƒâ‚â‚ = NaN
       #       error("ç¨‹åºç»ˆæ­¢ï¼šÏƒâ‚â‚çš„å€¼ä¸ºNaN")
       # end
        # println(Cáµ—â‚â‚â‚â‚)
        # println(Cáµ—â‚‚â‚‚â‚‚â‚‚)
        # println(Cáµ—â‚â‚â‚‚â‚‚)
        # println(Cáµ—â‚â‚‚â‚â‚‚)
       
        for (i,xáµ¢) in enumerate(ğ“’)
            I = xáµ¢.ğ¼
            for (j,xâ±¼) in enumerate(ğ“’)
                J = xâ±¼.ğ¼
                k[2*I-1,2*J-1] += (Cáµ—â‚â‚â‚â‚*Bâ‚[i]*Bâ‚[j] + Cáµ—â‚â‚‚â‚â‚‚*Bâ‚‚[i]*Bâ‚‚[j] + Cáµ—â‚â‚â‚â‚‚*(Bâ‚[i]*Bâ‚‚[j]+Bâ‚‚[i]*Bâ‚[j]))*ğ‘¤
                k[2*I-1,2*J]   += (Cáµ—â‚â‚â‚‚â‚‚*Bâ‚[i]*Bâ‚‚[j] + Cáµ—â‚â‚‚â‚â‚‚*Bâ‚‚[i]*Bâ‚[j] + Cáµ—â‚â‚â‚â‚‚*Bâ‚[i]*Bâ‚[j] + Cáµ—â‚‚â‚‚â‚â‚‚*Bâ‚‚[i]*Bâ‚‚[j])*ğ‘¤
                k[2*I,2*J-1]   += (Cáµ—â‚â‚â‚‚â‚‚*Bâ‚‚[i]*Bâ‚[j] + Cáµ—â‚â‚‚â‚â‚‚*Bâ‚[i]*Bâ‚‚[j] + Cáµ—â‚â‚â‚â‚‚*Bâ‚[i]*Bâ‚[j] + Cáµ—â‚‚â‚‚â‚â‚‚*Bâ‚‚[i]*Bâ‚‚[j])*ğ‘¤
                k[2*I,2*J]     += (Cáµ—â‚‚â‚‚â‚‚â‚‚*Bâ‚‚[i]*Bâ‚‚[j] + Cáµ—â‚â‚‚â‚â‚‚*Bâ‚[i]*Bâ‚[j] + Cáµ—â‚‚â‚‚â‚â‚‚*(Bâ‚[i]*Bâ‚‚[j]+Bâ‚‚[i]*Bâ‚[j]))*ğ‘¤
     
            end
            fint[2*I-1] += Bâ‚[i]*Î¾.Ïƒâ‚â‚*ğ‘¤ + Bâ‚‚[i]*Î¾.Ïƒâ‚â‚‚*ğ‘¤
            fint[2*I]   += Bâ‚[i]*Î¾.Ïƒâ‚â‚‚*ğ‘¤ + Bâ‚‚[i]*Î¾.Ïƒâ‚‚â‚‚*ğ‘¤
    
        end
    end
end    


"""
frictional-contact
"""
function (op::Operator{:âˆ«váµ¢ÏƒdÎ©_frictional_contact})(ap::T;k::AbstractMatrix{Float64},fint::AbstractVector{Float64}) where T<:AbstractElement
    ğ“’ = ap.ğ“’; ğ“– = ap.ğ“–
    Î» = op.Î»
    Î¼ = op.Î¼
    Î¼Ì„ = op.Î¼Ì„ 
    Î· = op.Î·
    tol = op.tol 
    Cáµ¢áµ¢áµ¢áµ¢ = Î» + 2.0*Î¼
    Cáµ¢áµ¢â±¼â±¼ = Î»
    Cáµ¢â±¼áµ¢â±¼ = Î¼
    
    for (ii,Î¾) in enumerate(ğ“–)#ç”¨æ¥è°ƒè¯•  çœ‹å…·ä½“ç‚¹çš„æƒ…å†µ
        N = Î¾[:ğ­]
        Bâ‚ = Î¾[:âˆ‚ğ­âˆ‚x]
        Bâ‚‚ = Î¾[:âˆ‚ğ­âˆ‚y]
        Ïƒâ‚â‚ = Î¾.Ïƒâ‚â‚
        Ïƒâ‚‚â‚‚ = Î¾.Ïƒâ‚‚â‚‚
        Ïƒâ‚ƒâ‚ƒ = Î¾.Ïƒâ‚ƒâ‚ƒ
        Ïƒâ‚â‚‚ = Î¾.Ïƒâ‚â‚‚
        ğ‘¤   = Î¾.ğ‘¤
        Î”Îµâ‚â‚ = 0.0
        Î”Îµâ‚‚â‚‚ = 0.0
        Î”Îµâ‚â‚‚ = 0.0
        v = 0.0
        âˆ‚vâˆ‚x = 0.0
        âˆ‚vâˆ‚y = 0.0
        for (i,xáµ¢) in enumerate(ğ“’)
            Î”Îµâ‚â‚ += Bâ‚[i]*xáµ¢.Î”dâ‚
            Î”Îµâ‚‚â‚‚ += Bâ‚‚[i]*xáµ¢.Î”dâ‚‚
            Î”Îµâ‚â‚‚ += Bâ‚[i]*xáµ¢.Î”dâ‚‚ + Bâ‚‚[i]*xáµ¢.Î”dâ‚
            v += N[i]*xáµ¢.v
            âˆ‚vâˆ‚x += Bâ‚[i]*xáµ¢.v
            âˆ‚vâˆ‚y += Bâ‚‚[i]*yáµ¢.v
        end 
        âˆ‡v = (âˆ‚vâˆ‚x,âˆ‚vâˆ‚y)
        n = âˆ‡v/norm(âˆ‡v)
        nâ‚ = n[1]
        nâ‚‚ = n[2]
        s  = [n[2],-n[1]]
        sâ‚ = s[1]
        sâ‚‚ = s[2]
        g(v) = v^2.0+ Î·
        # predict phase
        Îµâ‚â‚ += Bâ‚[j]*xâ±¼.dâ‚
        Îµâ‚‚â‚‚ += Bâ‚‚[j]*xâ±¼.dâ‚‚
        Îµâ‚â‚‚ += Bâ‚[j]*xâ±¼.dâ‚‚ + Bâ‚‚[j]*xâ±¼.dâ‚ 
        Îµâ‚™ = Îµâ‚â‚*nâ‚*nâ‚+2.0*Îµâ‚â‚‚*nâ‚*nâ‚‚+Îµâ‚‚â‚‚*nâ‚‚*nâ‚‚
        Ïƒâ‚â‚áµ—Ê³ = Ïƒâ‚â‚ + Cáµ¢áµ¢áµ¢áµ¢*Î”Îµâ‚â‚+Cáµ¢áµ¢â±¼â±¼*Î”Îµâ‚‚â‚‚
        Ïƒâ‚‚â‚‚áµ—Ê³ = Ïƒâ‚‚â‚‚ + Cáµ¢áµ¢áµ¢áµ¢*Î”Îµâ‚‚â‚‚+Cáµ¢áµ¢â±¼â±¼*Î”Îµâ‚â‚
        Ïƒâ‚â‚‚áµ—Ê³ = Ïƒâ‚â‚‚ + Cáµ¢â±¼áµ¢â±¼*Î”Îµâ‚â‚‚
        Ï„ = Ïƒâ‚â‚áµ—Ê³*nâ‚*sâ‚+Ïƒâ‚â‚‚áµ—Ê³*nâ‚*sâ‚‚+Ïƒâ‚â‚‚áµ—Ê³*nâ‚‚*sâ‚+Ïƒâ‚‚â‚‚áµ—Ê³*nâ‚‚*sâ‚‚
        Fâ‚™ = Ïƒâ‚â‚áµ—Ê³*nâ‚*nâ‚+Ïƒâ‚â‚‚áµ—Ê³*nâ‚*nâ‚‚+Ïƒâ‚â‚‚áµ—Ê³*nâ‚‚*nâ‚+Ïƒâ‚‚â‚‚áµ—Ê³*nâ‚‚*nâ‚‚


        f = abs(Ï„)+Î¼Ì„ *Fâ‚™
        if v â‰ˆ 0.0
           Î¾.Ïƒâ‚â‚ = Ïƒâ‚â‚áµ—Ê³
           Î¾.Ïƒâ‚‚â‚‚ = Ïƒâ‚‚â‚‚áµ—Ê³
           Î¾.Ïƒâ‚â‚‚ = Ïƒâ‚â‚‚áµ—Ê³
           Cáµ—â‚â‚â‚â‚ = Cáµ¢áµ¢áµ¢áµ¢
           Cáµ—â‚‚â‚‚â‚‚â‚‚ = Cáµ¢áµ¢áµ¢áµ¢
           Cáµ—â‚â‚â‚‚â‚‚ = Cáµ¢áµ¢â±¼â±¼ 
           Cáµ—â‚‚â‚‚â‚â‚ = Cáµ¢áµ¢â±¼â±¼
           Cáµ—â‚â‚‚â‚â‚‚ = Cáµ¢â±¼áµ¢â±¼ 
           Cáµ—â‚â‚â‚â‚‚ = 0.0
           Cáµ—â‚‚â‚‚â‚â‚‚ = 0.0
        else
            if Îµâ‚™ > 0.0
               Î¾.Ïƒâ‚â‚ = g(v)*Ïƒâ‚â‚áµ—Ê³
               Î¾.Ïƒâ‚‚â‚‚ = g(v)Ïƒâ‚‚â‚‚áµ—Ê³
               Î¾.Ïƒâ‚â‚‚ = g(v)Ïƒâ‚â‚‚áµ—Ê³
               Cáµ—â‚â‚â‚â‚ = g(v)*Cáµ¢áµ¢áµ¢áµ¢
               Cáµ—â‚‚â‚‚â‚‚â‚‚ = g(v)*Cáµ¢áµ¢áµ¢áµ¢
               Cáµ—â‚â‚â‚‚â‚‚ = g(v)*Cáµ¢áµ¢â±¼â±¼ 
               Cáµ—â‚‚â‚‚â‚â‚ = g(v)*Cáµ¢áµ¢â±¼â±¼
               Cáµ—â‚â‚‚â‚â‚‚ = g(v)*Cáµ¢â±¼áµ¢â±¼ 
               Cáµ—â‚â‚â‚â‚‚ = 0.0
               Cáµ—â‚‚â‚‚â‚â‚‚ = 0.0
            else
               if f < tol
                   Î¾.Ïƒâ‚â‚ = Ïƒâ‚â‚áµ—Ê³
                   Î¾.Ïƒâ‚‚â‚‚ = Ïƒâ‚‚â‚‚áµ—Ê³
                   Î¾.Ïƒâ‚â‚‚ = Ïƒâ‚â‚‚áµ—Ê³
                   Cáµ—â‚â‚â‚â‚ = Cáµ¢áµ¢áµ¢áµ¢
                   Cáµ—â‚‚â‚‚â‚‚â‚‚ = Cáµ¢áµ¢áµ¢áµ¢
                   Cáµ—â‚â‚â‚‚â‚‚ = Cáµ¢áµ¢â±¼â±¼ 
                   Cáµ—â‚‚â‚‚â‚â‚ = Cáµ¢áµ¢â±¼â±¼
                   Cáµ—â‚â‚‚â‚â‚‚ = Cáµ¢â±¼áµ¢â±¼ 
                   Cáµ—â‚â‚â‚â‚‚ = 0.0             
                   Cáµ—â‚‚â‚‚â‚â‚‚ = 0.0
               else
                  Cá¶ â‚â‚â‚â‚ = -Î¼Ì„ *sign(Ï„)*(Î»+2.0*Î¼*nâ‚*nâ‚)*(nâ‚*sâ‚+nâ‚*sâ‚)
                  Cá¶ â‚‚â‚‚â‚‚â‚‚ = -Î¼Ì„ *sign(Ï„)*(Î»+2.0*Î¼*nâ‚‚*nâ‚‚)*(nâ‚‚*sâ‚‚+nâ‚‚*sâ‚‚)
                  Cá¶ â‚â‚â‚‚â‚‚ = -Î¼Ì„ *sign(Ï„)*(Î»+2.0*Î¼*nâ‚‚*nâ‚‚)*(nâ‚*sâ‚+nâ‚*sâ‚)
                  Cá¶ â‚‚â‚‚â‚â‚ = -Î¼Ì„ *sign(Ï„)*(Î»+2.0*Î¼*nâ‚*nâ‚)*(nâ‚‚*sâ‚‚+nâ‚‚*sâ‚‚)
                  Cá¶ â‚â‚â‚â‚‚ = -Î¼Ì„ *sign(Ï„)*(2.0*Î¼*nâ‚*nâ‚‚)*(nâ‚*sâ‚+nâ‚*sâ‚)
                  Cá¶ â‚‚â‚‚â‚‚â‚ = -Î¼Ì„ *sign(Ï„)*(2.0*Î¼*nâ‚*nâ‚‚)*(nâ‚‚*sâ‚‚+nâ‚‚*sâ‚‚) 
                  Cá¶ â‚â‚‚â‚â‚‚ = -Î¼Ì„ *sign(Ï„)*(2.0*Î¼*nâ‚*nâ‚‚)*(nâ‚*sâ‚‚+nâ‚‚*sâ‚)

                  CÊ³â‚â‚â‚â‚ =  Î¼*(nâ‚*sâ‚+nâ‚*sâ‚)*(nâ‚*sâ‚+nâ‚*sâ‚)
                  CÊ³â‚‚â‚‚â‚‚â‚‚ =  Î¼*(nâ‚‚*sâ‚‚+nâ‚‚*sâ‚‚)*(nâ‚‚*sâ‚‚+nâ‚‚*sâ‚‚)
                  CÊ³â‚â‚â‚‚â‚‚ =  Î¼*(nâ‚‚*sâ‚‚+nâ‚‚*sâ‚‚)*(nâ‚*sâ‚+nâ‚*sâ‚)
                  CÊ³â‚‚â‚‚â‚â‚ =  Î¼*(nâ‚*sâ‚+nâ‚*sâ‚)*(nâ‚‚*sâ‚‚+nâ‚‚*sâ‚‚)
                  CÊ³â‚â‚â‚â‚‚ =  Î¼*(nâ‚*sâ‚‚+nâ‚‚*sâ‚)*(nâ‚*sâ‚+nâ‚*sâ‚)
                  CÊ³â‚‚â‚‚â‚‚â‚ =  Î¼*(nâ‚*sâ‚‚+nâ‚‚*sâ‚)*(nâ‚‚*sâ‚‚+nâ‚‚*sâ‚‚)
                  CÊ³â‚â‚‚â‚â‚‚ =  Î¼*(nâ‚*sâ‚‚+nâ‚‚*sâ‚)*(nâ‚*sâ‚‚+nâ‚‚*sâ‚)

                  Î¾.Ïƒâ‚â‚ = Ïƒâ‚â‚áµ—Ê³+(1-g(v))*(Cá¶ â‚â‚â‚â‚-CÊ³â‚â‚â‚â‚)*Îµâ‚â‚
                  Î¾.Ïƒâ‚‚â‚‚ = Ïƒâ‚‚â‚‚áµ—Ê³+(1-g(v))*(Cá¶ â‚‚â‚‚â‚‚â‚‚-CÊ³â‚‚â‚‚â‚‚â‚‚)*Îµâ‚‚â‚‚
                  Î¾.Ïƒâ‚â‚‚ = Ïƒâ‚â‚‚áµ—Ê³+(1-g(v))*(Cá¶ â‚â‚‚â‚â‚‚-CÊ³â‚â‚‚â‚â‚‚)*Îµâ‚â‚‚

                  Cáµ—â‚â‚â‚â‚ = Cáµ¢áµ¢áµ¢áµ¢ +(1-g(v))*(Cá¶ â‚â‚â‚â‚-CÊ³â‚â‚â‚â‚)
                  Cáµ—â‚‚â‚‚â‚‚â‚‚ = Cáµ¢áµ¢áµ¢áµ¢ +(1-g(v))*(Cá¶ â‚‚â‚‚â‚‚â‚‚-CÊ³â‚‚â‚‚â‚‚â‚‚)
                  Cáµ—â‚â‚â‚‚â‚‚ = Cáµ¢áµ¢â±¼â±¼ +(1-g(v))*(Cá¶ â‚â‚â‚‚â‚‚-CÊ³â‚â‚â‚‚â‚‚)
                  Cáµ—â‚‚â‚‚â‚â‚ = Cáµ¢áµ¢â±¼â±¼ +(1-g(v))*(Cá¶ â‚‚â‚‚â‚â‚-CÊ³â‚‚â‚‚â‚â‚)
                  Cáµ—â‚â‚‚â‚â‚‚ = Cáµ¢â±¼áµ¢â±¼ +(1-g(v))*(Cá¶ â‚â‚‚â‚â‚‚-CÊ³â‚â‚‚â‚â‚‚)
                  Cáµ—â‚â‚â‚â‚‚ = 0.0   +(1-g(v))*(Cá¶ â‚â‚â‚â‚‚-CÊ³â‚â‚â‚â‚‚)
                  Cáµ—â‚‚â‚‚â‚â‚‚ = 0.0   +(1-g(v))*(Cá¶ â‚‚â‚‚â‚â‚‚-CÊ³â‚‚â‚‚â‚â‚‚)
           
                end 
            end    
       end          
       for (i,xáµ¢) in enumerate(ğ“’)
           I = xáµ¢.ğ¼
           for (j,xâ±¼) in enumerate(ğ“’)
               J = xâ±¼.ğ¼
               k[2*I-1,2*J-1] += (Cáµ—â‚â‚â‚â‚*Bâ‚[i]*Bâ‚[j] + Cáµ—â‚â‚‚â‚â‚‚*Bâ‚‚[i]*Bâ‚‚[j] + Cáµ—â‚â‚â‚â‚‚*(Bâ‚[i]*Bâ‚‚[j]+Bâ‚‚[i]*Bâ‚[j]))*ğ‘¤
               k[2*I-1,2*J]   += (Cáµ—â‚â‚â‚‚â‚‚*Bâ‚[i]*Bâ‚‚[j] + Cáµ—â‚â‚‚â‚â‚‚*Bâ‚‚[i]*Bâ‚[j] + Cáµ—â‚â‚â‚â‚‚*Bâ‚[i]*Bâ‚[j] + Cáµ—â‚‚â‚‚â‚â‚‚*Bâ‚‚[i]*Bâ‚‚[j])*ğ‘¤
               k[2*I,2*J-1]   += (Cáµ—â‚‚â‚‚â‚â‚*Bâ‚‚[i]*Bâ‚[j] + Cáµ—â‚â‚‚â‚â‚‚*Bâ‚[i]*Bâ‚‚[j] + Cáµ—â‚â‚â‚â‚‚*Bâ‚[i]*Bâ‚[j] + Cáµ—â‚‚â‚‚â‚â‚‚*Bâ‚‚[i]*Bâ‚‚[j])*ğ‘¤
               k[2*I,2*J]     += (Cáµ—â‚‚â‚‚â‚‚â‚‚*Bâ‚‚[i]*Bâ‚‚[j] + Cáµ—â‚â‚‚â‚â‚‚*Bâ‚[i]*Bâ‚[j] + Cáµ—â‚‚â‚‚â‚â‚‚*(Bâ‚[i]*Bâ‚‚[j]+Bâ‚‚[i]*Bâ‚[j]))*ğ‘¤
       
           end
           fint[2*I-1] += Bâ‚[i]*Î¾.Ïƒâ‚â‚*ğ‘¤ + Bâ‚‚[i]*Î¾.Ïƒâ‚â‚‚*ğ‘¤
           fint[2*I]   += Bâ‚[i]*Î¾.Ïƒâ‚â‚‚*ğ‘¤ + Bâ‚‚[i]*Î¾.Ïƒâ‚‚â‚‚*ğ‘¤
   
       end
    end
end    
function calculate_n_and_s_vectors(nodes, v,  L)
    Î“tmp = Set{Int}()
    Î“final = Set{Int}()
    for (i, v) in enumerate(v)
        if v > 0.98
            push!(Î“tmp, i)
        end
    end

    while !isempty(Î“tmp)
        max_v, max_node = findmax(v[collect(Î“tmp)])
        Î“tmp = setdiff(Î“tmp, [max_node])
        for node in Î“tmp
            distance = norm(nodes[max_node] - nodes[node])
            if distance <= L
                push!(Î“final, node)
            end
        end
        Î“tmp = setdiff(Î“tmp, Î“final)
    end
    sorted_nodes = sort(collect(Î“final), by = node -> nodes[node][1])  
    crack_path = [nodes[node] for node in sorted_nodes]

    normals = []
    slips = []

    for i in 1:length(crack_path)-1
        segment = crack_path[i+1] - crack_path[i]
        n = normalize([-segment[2], segment[1]])
        s = [n[2], -n[1]]
        push!(normals, n)
        push!(slips, s)
    end

    return normals, slips
end